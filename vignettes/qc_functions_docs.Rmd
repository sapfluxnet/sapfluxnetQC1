---
title: "Quality Check functions documentation"
author: "Victor Granda (Sapfluxnet Team)"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

Quality check functions are intended to work together, but each of them has
its pecualirities. This vignette explain all written functions including
a diagram with the algorithm used and explanations when needed.


# Coordinates checks functions

These functions are intended to perform a quality check in the site coordinates
provided by the contributors. They involve downloading the country maps,
check de sign, fix the sign if needed and another checks. Finally, there is
a wrapper function (`qc_coordinates`) which allow to perform all the checks in
one step. This makes possible to add any new coordinates checks to the workflow
without gnereating so much complexity.

## `qc_download_maps`

This function fecth maps from [gadm](http://www.gadm.org/) if the maps are not
already downloaded in the maps folder specified. See function help for more
details in the arguments and expected value (`?qc_download_maps`).  

<img src="qc_download_maps.svg" alt="qc_download_maps" style="width: 500px;"/>


## `qc_check_coordinates`

This function retrieves the coordinates provided fir the site, and check them
against the country coordinates. It uses `qc_download_maps` internally to
fecth any map if needed. See function help for more details in the
arguments and expected value (`?qc_check_coordinates`).  

<img src="qc_check_coordinates.svg" alt="qc_check_coordinates" style="width: 500px;"/>

## `qc_coord_sign_test`

Internal function to establish countries coordinates sign and test if provided
site coordinates are correct. This function only provides info about the
possible sign changes, but fix is not made here. See function help for
more details about the arguments, special_countries step and expected value
(`?qc_cood_sign_test`).  

<img src="qc_coord_sign_test.svg" alt="qc_coord_sign_test" style="width: 500px;"/>


## `qc_fix_latlong_errors`

This function fixes several known errors in the coordinates provided for the site.
It is intended to be modular, being able to add new fixes if needed, as this
function uses other internal functions as `qc_check_coordinates` and
`qc_coord_sign_test`. See function help for more details about the arguments,
(`?qc_fix_latlong_errors`).  

<img src="qc_fix_latlong_errors.svg" alt="qc_fix_latlong_errors" style="width: 500px;"/>

## `qc_coordinates`

Wrapper around all the previous functions to perform the coordinates quality
check in only one step. See function help for more details about the arguments,
(`?qc_coordinates`).  

<img src="qc_coordinates.svg" alt="qc_coordinates" style="width: 500px;"/>

# Data general checks functions

These functions perform general checks within the data (environmental and
sapflow). At the moment, most of the checks are related to the TIMESTAMP.

## `qc_is_timestamp`

This function tests if TIMESTAMP variable is in POSIXct format, as expected. See
function help for more details about the arguments, (`?qc_is_timestamp`).  

<img src="qc_is_timestamp.svg" alt="qc_is_timestamp" style="width: 800px;"/>

## `qc_get_timezone`

Function to transform the provided ISO coded timezone value (`env_time_zone`
variable) in a character string compatible with `lubridate` package and POSIXct
format. See function help for more details about the arguments,
(`?qc_get_timezone`).  

<img src="qc_get_timezone.svg" alt="qc_get_timezone" style="width: 250px;"/>

## `qc_set_timezone`

When reading data from csv, TIMESTAMP timezone is settled to `UTC`. This
function allows setting the TIMESTAMP timezone without changing the variable.
See function help for more details about the arguments, (`?qc_set_timezone`).  

<img src="qc_set_timezone.svg" alt="qc_set_timezone" style="width: 500px;"/>

## `qc_as_timestamp`

When loading the TIMESTAMP varible, specially from csv files, sometimes results
in bad formatted TIMESTAMP. This function looks for known bad formats and fix
them. It uses internally `qc_is_timestamp`, `qc_get_timezone` and `qc_set_timezone`
to achieve the correct TIMESTAMP format. See function help for more details
about the arguments, (`?qc_as_timestamp`).  

<img src="qc_as_timestamp.svg" alt="qc_as_timestamp" style="width: 750px;"/>

## `qc_fix_timestamp`

Wrapper for timestamp functions. It uses internally `qc_is_timestamp` and
`qc_as_timestamp` to check and fix, if possible, the TIMESTAMP. See funtion help
for more details about arguments, (`?qc_fix_timestamp`).  

<img src="qc_fix_timestamp.svg" alt="qc_fix_timestamp" style="width: 500px;"/>

## `qc_get_timestep`

Helper function to retrieve the timestep from the from the plant (sapflow) or
the environmental metadata. This helper function will be used in the
`qc_timestamp_errors` function. See function help for more details about the
arguments, (`?qc_get_timestep`).

<img src="qc_get_timestep.svg" alt="qc_get_timestep" style="width: 650px;"/>

## `qc_timestamp_errors`

Function to identify known errors in TIMESTAMP variable. A summary of intervals
59 seconds away from the declared timestep is presented in order to locate the
errors. See function help for more details about the arguments,
(`?qc_timestamp_errors`).

<img src="qc_timestamp_errors.svg" alt="qc_timestamp_errors" style="width: 500px;"/>

## `qc_time_interval`

This function obtains a summary of the inital and final time (t0 and tf) of
each object in the data (plants or environmental variables). See function help
for more details about the arguments, (`?qc_time_interval`).

<img src="qc_time_interval.svg" alt="qc_time_interval" style="width: 500px;"/>

## `qc_timestamp_concordance`

Function to retrieve numerical or graphical information about concordance in
the timestamp for both, environmental and sapflow data. See function help for
more details about the arguments, (`?qc_timestamp_concordance`).

<img src="qc_timestamp_concordance.svg" alt="qc_timestamp_concordance" style="width: 500px;"/>

## `qc_solar_timestamp`

TO DO

# Gaps functions

Functions for characterise the gaps (type, length...).

## `qc_mind_the_gap`

This function obtains info about the gaps and display it in a summary data frame.
See function help for details about the arguments, (`?qc_mind_the_gap`).  

<img src="qc_mind_the_gap.svg" alt="qc_mind_the_gap" style="width: 750px;"/>

# Metadata general checks

Functions to perform the quality check in the metadata. They include the five
kinds of metadata (site, stand, plant, species and environmental) as well as
the interface between metadata and data (checks that involves both kind of data).

## `create_dic`

This function creates dictionaries (named lists) for the specified kind of
metadata, including the name of the metadata variables as labels and their
expected class as the value. This provides a reference to check if the class is
OK with the `qc_md_cols` function. See function help for details about the
arguments, (`?create_dic`).

<img src="create_dic.svg" alt="create_dic" style="width: 650px;"/>

## `qc_site_dics`

This function creates a dictionary (character vector) with the allowed values
for the factor variable of site metadata specified in the arguments. See function
help for details about the arguments, (`?qc_site_dics`).  

<img src="qc_site_dics.svg" alt="qc_site_dics" style="width: 650px;"/>

## `qc_stand_dics`

This function creates a dictionary (character vector) with the allowed values
for the factor variable of stand metadata specified in the arguments. See function
help for details about the arguments, (`?qc_stand_dics`).  

<img src="qc_stand_dics.svg" alt="qc_stand_dics" style="width: 650px;"/>

## `qc_species_dics`

This function creates a dictionary (character vector) with the allowed values
for the factor variable of species metadata specified in the arguments. See function
help for details about the arguments, (`?qc_species_dics`).  

<img src="qc_species_dics.svg" alt="qc_species_dics" style="width: 650px;"/>

## `qc_plant_dics`

This function creates a dictionary (character vector) with the allowed values
for the factor variable of plant metadata specified in the arguments. See function
help for details about the arguments, (`?qc_plant_dics`).  

<img src="qc_plant_dics.svg" alt="qc_plant_dics" style="width: 650px;"/>

## `qc_env_dics`

This function creates a dictionary (character vector) with the allowed values
for the factor variable of environmental metadata specified in the arguments.
See function help for details about the arguments, (`?qc_env_dics`).  

<img src="qc_env_dics.svg" alt="qc_env_dics" style="width: 650px;"/>

## `qc_md_cols`

This functions checks for presence, NAs and classes of the variables provided
in the different kinds of metadata, buiding a summary data frame as result.
See function help for details about the arguments, (`?qc_md_cols`).

<img src="qc_md_cols.svg" alt="qc_md_cols" style="width: 750px;"/>

## `qc_factor_values`

This function checks if the values provided for the factor metadata variables are
allowed values. See function help for details about the arguments,
(`?qc_factor_values`).  

<img src="qc_factor_values.svg" alt="qc_factor_values" style="width: 750px;"/>

## `qc_env_vars_presence`

This function check the presence in the environmental data of variables
declared as measured in the environmental metadata. See function help for details
about arguments, (`?qc_env_vars_presence`)

<img src="qc_env_vars_presence.svg" alt="qc_env_vars_presence" style="width: 650px;"/>

## `qc_pl_treatments`

This function summarizes the treatments declared in the plant metadata to look
for mispelling and concordance errors. Results are summarised in a data frame.
See function help for details about arguments, (`?qc_pl_treatments`).  

<img src="qc_pl_treatments.svg" alt="qc_pl_treatments" style="width: 200px;"/>

## `qc_email_check`

This function checks if the email provided is a correct formatted email
direction. See function help for details about arguments, (`?qc_email_check`).  

<img src="qc_email_check.svg" alt="qc_email_check" style="width: 500px;"/>

## `qc_species_names_info`

This function uses the tpl and tpl_data packages (from github) to obtain
the correct species names (if any correction is needed). A summary data frame
is returned to use in `qc_species_names_fix` function.
See function help for details about arguments, (`?qc_species_names_info`).  

<img src="qc_species_names_info.svg" alt="qc_species_names_info" style="width: 500px;"/>

## `qc_species_names_fix`

This function takes the results of `qc_species_names_info` and return the
tpl names if no NAs has been generated.
See function help for details about arguments, (`?qc_species_names_fix`).  

<img src="qc_species_names_fix.svg" alt="qc_species_names_fix" style="width: 300px;"/>

## `qc_species_names`

Wrapper for species_names_info and species_names_fix.
See function help for details about arguments, (`?qc_species_names`).  

<img src="qc_species_names.svg" alt="qc_species_names" style="width: 300px;"/>

## `qc_species_verification`

This function return a summary indicating if the species declared in the
species metadata are the same that those indicated in the plant metadata.
See function help for details about arguments, (`?qc_species_verification`).  

<img src="qc_species_verification.svg" alt="qc_species_verification" style="width: 500px;"/>

# Ranges checks

This group of functions check that the provided numerical values are within the
natural/typical/known ranges. It is a work in progress.

## `qc_suitable_range`

Function to check if the numerical value provided is within the ranges provided.
It is a wrapper for functions yet to do.

## `qc_sapf_range_check`

Function to make a suitability test in the sap flow values provided. Values
are tested to be within the ranges for sap flow measures observed in the
literature. See function help for details about arguments,
(`?qc_sapf_range_check`).  

<img src="qc_sapf_range_check.svg" alt="qc_sapf_range_check" style="width: 650px;"/>
