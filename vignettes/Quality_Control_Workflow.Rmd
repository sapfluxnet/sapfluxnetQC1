---
title: "Quality Control Workflow"
author: "SapFluxNet Team"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Quality Control Workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

In this vignette, the workflow for the first steps of quality control of metadata
are explained. This workflow involves the use of the functions developed in the
`sapfluxnetr` package in a proper way to ensure the correctness of retrieved data.

## Data retrieving

Data is located in a SQL database (a MySQL database at the time of writing), so
the first thing to do is retrieve the data using the `RMySQL` package:

```{r database_access, eval = FALSE}
# Load libraries
library(sapfluxnetr) # metadata QC functions
library(RMySQL) # database access
library(magrittr) # pipes to code more easily

# Connect to the database to obtain site coordinates, country
# and stand name.
mydb <- dbConnect(
  MySQL(), # database protocol
  user = 'sfnform', # username
  password = '5fNf0rM', # user password
  dbname = 'sfnform', # database name
  host = '144.76.203.10' # database host
)

# Database query
res <- dbSendQuery(
  mydb,
  'SELECT * FROM sfnform_metadataform'
)

# Fetch data into a data_frame
data = fetch(res, n=-1)

# Check data
data

# Close database connection and cleaning workspace
dbDisconnect(mydb)
rm(list = c('mydb', 'res'))
```

In the database query, using `*` indicates that all the variables of the table
are retrieved:

    'SELECT * FROM sfnform_metadataform'

Instead of all of them, we can select only those variables that we need:

    'SELECT longitude, latitude, country, site_name 
     FROM sfnform_metadataform'

In the last example, only longitude, latitude, country and site_name are
retrieved.

## Quality Control 1: Coordinates checking workflow

The first step in the metadata quality control is to verify if the provided
coordinates are correct. For that, `sapfluxnetr` package offers two functions
that used together return a report of possible coordinates errors:

  1. `download_maps`
  
  2. `check_coordinates`

Using this functions is easy^[Especially if using `magrittr` pipes]:

```{r coord_check_wf, eval = FALSE}
coord_report <- 
  data %T>%   # with data
  download_maps(folder = 'maps_folder_name') %>%    # download the maps
  check_coordinates(maps_folder = 'maps_folder_name',
                    plot = TRUE, text_report = TRUE)  # and finally, check coords

# View report
coord_report

# show only wrong coordinates
library(dplyr)

coord_report %>%
  filter(!is_inside_country)

# show only correct coordinates
coord_report %>%
  filter(is_inside_country)
```
